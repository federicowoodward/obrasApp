<p-toast></p-toast>

<div class="flex flex-column sm:flex-row justify-content-between mb-3 gap-4">
  <div class="flex flex-row gap-2">
    <!-- Categorías -->
    <div class="flex items-center gap-2">
      <p-iftalabel>
        <label for="categories">Categorías: </label>
        <select
          class="p-inputtext"
          id="categories"
          (change)="onCategoryChange($event)"
          [value]="selectedCategoryId() || 0"
        >
          <option [value]="0">Todas</option>
          <option *ngFor="let cat of categories()" [value]="cat.id">
            {{ cat.name }}
          </option>
        </select>
      </p-iftalabel>
    </div>

    <!-- Ubicaciones -->
    <div class="flex items-center gap-2">
      <p-iftalabel>
        <label for="locations">Ubicaciones: </label>
        <select
          class="p-inputtext"
          id="locations"
          (change)="onLocationChange($event)"
          [value]="selectedLocationKey()"
        >
          <option value="all">Todas</option>
          <option *ngFor="let loc of locations()" [value]="loc.key">
            {{ loc.name }}
          </option>
        </select>
      </p-iftalabel>
    </div>
  </div>

  <button
    pButton
    type="button"
    icon="pi pi-plus"
    class="w-15rem"
    label="Agregar Elemento"
    (click)="openAddDialog()"
  ></button>
</div>

<div class="w-full">
  <p-table
    #dt
    [value]="filteredElements()"
    dataKey="id"
    [rows]="10"
    [rowsPerPageOptions]="[10, 25, 50]"
    [paginator]="true"
    [globalFilterFields]="['name', 'category.name', 'location.name']"
    responsiveLayout="scroll"
  >
    <!-- Caption: buscador global -->
    <ng-template pTemplate="caption">
      <div class="flex justify-content-end">
        <span class="p-input-icon-left">
          <input
            pInputText
            type="text"
            (input)="onGlobalFilter($event, dt)"
            placeholder="Buscar por nombre o categoría..."
            class="w-20rem"
          />
        </span>
      </div>
    </ng-template>

    <!-- Encabezado: vista simple -->
    <ng-template pTemplate="header">
      <tr>
        <th>Nombre</th>
        <th>Categoría</th>
        <th>Ubicación</th>
      </tr>
    </ng-template>

    <ng-template pTemplate="body" let-el let-expanded="expanded">
      <tr>
        <td class="flex align-items-center gap-2">
          <button
            pButton
            [pRowToggler]="el"
            type="button"
            [text]="true"
            class="mr-2"
            [icon]="expanded ? 'pi pi-chevron-down' : 'pi pi-chevron-right'"
            pTooltip="Ver más"
            tooltipPosition="bottom"
          ></button>
          <span class="font-medium">{{ el.name }}</span>
        </td>
        <td>{{ el.category?.name || "-" }}</td>
        <td>
          {{
            getLocationName(el.location?.locationId, el.location?.locationType)
          }}
        </td>
      </tr>
    </ng-template>

    <ng-template #expandedrow let-el>
      <tr>
        <td colspan="3">
          <div
            class="flex flex-column md:flex-row justify-content-between py-3"
          >
            <div class="flex flex-column">
              <span class="text-sm text-color-secondary">Marca</span>
              <span class="font-medium">{{ el.brand || "-" }}</span>
            </div>
            <div class="flex flex-column">
              <span class="text-sm text-color-secondary">Proveedor</span>
              <span class="font-medium">{{ el.provider || "-" }}</span>
            </div>
            <div class="flex flex-column">
              <span class="text-sm text-color-secondary">Fecha de compra</span>
              <span class="font-medium">
                {{ el.buyDate ? (el.buyDate | date : "yyyy-MM-dd") : "-" }}
              </span>
            </div>

            <div class="flex gap-2 align-items-start md:align-items-center">
              <!-- Si el elemento tiene nota embebida, mostramos Editar -->
              <ng-container *ngIf="el.note?.id; else createNoteBtn">
                <button
                  pButton
                  icon="pi pi-pencil"
                  label="Editar nota"
                  outlined
                  (click)="editNote(el.note.id)"
                ></button>
              </ng-container>

              <!-- Si no tiene nota, mostramos Crear -->
              <ng-template #createNoteBtn>
                <button
                  pButton
                  icon="pi pi-plus"
                  label="Crear nota"
                  outlined
                  (click)="createNoteForElement(el.id)"
                ></button>
              </ng-template>

              <button
                pButton
                icon="pi pi-pencil"
                label="Editar"
                (click)="openEditDialog(el)"
              ></button>

              <button
                pButton
                icon="pi pi-trash"
                label="Eliminar"
                severity="danger"
                (click)="confirmDeleteElement($event, el.id)"
              ></button>
            </div>
          </div>
        </td>
      </tr>
    </ng-template>

    <ng-template pTemplate="emptymessage">
      <tr>
        <td colspan="3">No se encontraron elementos.</td>
      </tr>
    </ng-template>
  </p-table>
</div>

<!-- Dialogo de alta/edición -->
<p-dialog
  [(visible)]="displayDialog"
  modal
  [closable]="false"
  [style]="{ width: '640px', maxWidth: '95vw' }"
  header="{{ isNew() ? 'Agregar Elemento' : 'Editar Elemento' }}"
  styleClass="p-3"
  [resizable]="false"
>
  <form [formGroup]="form" (ngSubmit)="saveElement()" class="flex flex-column">
    <div class="p-fluid flex flex-column gap-2">
      <div class="p-field">
        <p-iftalabel>
          <label for="name">Nombre*</label>
          <input pInputText id="name" formControlName="name" class="w-full" />
        </p-iftalabel>
      </div>

      <div class="grid">
        <div class="col-12 md:col-6">
          <p-iftalabel>
            <label for="categoryId">Categoría*</label>
            <select
              pInputText
              id="categoryId"
              formControlName="categoryId"
              class="w-full"
            >
              <option [value]="null" disabled selected>
                Seleccioná una categoría
              </option>
              <option *ngFor="let cat of categories()" [value]="cat.id">
                {{ cat.name }}
              </option>
            </select>
          </p-iftalabel>
        </div>

        <div class="col-12 md:col-6">
          <p-iftalabel>
            <label for="locationId">Ubicación*</label>
            <select
              pInputText
              id="locationId"
              formControlName="locationId"
              class="w-full"
              (change)="onLocationChange($event)"
            >
              <option *ngFor="let loc of locations()" [value]="loc.id">
                {{ loc.name }} ({{
                  loc.type === "deposit" ? "Depósito" : "Obra"
                }})
              </option>
            </select>
          </p-iftalabel>
        </div>
      </div>

      <div class="grid">
        <div class="col-12 md:col-4">
          <p-iftalabel>
            <label for="brand">Marca*</label>
            <input
              pInputText
              id="brand"
              formControlName="brand"
              class="w-full"
            />
          </p-iftalabel>
        </div>

        <div class="col-12 md:col-4">
          <p-iftalabel>
            <label for="provider">Proveedor*</label>
            <input
              pInputText
              id="provider"
              formControlName="provider"
              class="w-full"
            />
          </p-iftalabel>
        </div>

        <div class="col-12 md:col-4">
          <p-iftalabel>
            <label for="buyDate">Fecha de Compra*</label>
            <input
              pInputText
              type="date"
              id="buyDate"
              formControlName="buyDate"
              class="w-full"
            />
          </p-iftalabel>
        </div>
      </div>
    </div>

    <div class="flex justify-content-end mt-4 gap-2">
      <button
        pButton
        label="Cancelar"
        class="p-button-text"
        type="button"
        (click)="cancelDialog()"
      ></button>
      <button
        pButton
        [label]="isNew() ? 'Agregar' : 'Guardar'"
        type="submit"
        [disabled]="form.invalid"
      ></button>
    </div>
  </form>
</p-dialog>

<p-confirmpopup />
