<div class="flex flex-column gap-3">
  <div class="flex justify-content-between align-items-center">
    <h2 class="m-0">Registro de faltantes</h2>
    <div class="flex gap-2">
      <p-dropdown
        [options]="statusOptions"
        [(ngModel)]="statusFilter"
        optionLabel="label"
        optionValue="value"
        placeholder="Todos"
        styleClass="w-12rem"
        (onChange)="applyFilter()"
      ></p-dropdown>

      <p-checkbox
        binary="true"
        [(ngModel)]="onlyUrgent"
        inputId="urgent"
        (onChange)="applyFilter()"
      ></p-checkbox>
      <label for="urgent" class="ml-2">Sólo urgentes</label>

      <p-button
        label="Actualizar"
        (click)="refresh()"
        [loading]="svc.loading()"
      />
    </div>
  </div>

  <p-table
    [value]="filtered()"
    [paginator]="true"
    [rows]="15"
    [responsiveLayout]="'scroll'"
    dataKey="id"
  >
    <ng-template pTemplate="header">
      <tr>
        <th style="width: 4rem">#</th>
        <th>Título</th>
        <th>Detalle</th>
        <th>Obra</th>
        <th>Obrero</th>
        <th>Estado</th>
        <th>Creado</th>
        <th style="width: 22rem">Acciones</th>
      </tr>
    </ng-template>

    <ng-template pTemplate="body" let-m>
      <tr>
        <td>
          <p-tag *ngIf="m.urgent" severity="danger" value="!" />
        </td>
        <td class="font-medium">{{ m.title }}</td>
        <td class="opacity-80 w-24rem text-overflow-ellipsis">{{ m.text }}</td>
        <td>#{{ m.construction?.id }} {{ m.construction?.title || '' }}</td>
        <td>
          {{ m.constructionWorker?.name || ('#' + m.constructionWorker?.id) }}
        </td>
        <td>
          <p-tag
            [severity]="m.status === 'pending' ? 'warning' : m.status === 'done' ? 'success' : 'secondary'"
            [value]="statusLabel(m.status)"
          />
        </td>
        <td>{{ m.createdAt | date: 'short' }}</td>
        <td>
          <div class="flex gap-2">
            <p-button
              label="Listo"
              size="small"
              icon="pi pi-check"
              [disabled]="m.status === 'done'"
              (click)="markDone(m.id)"
            />
            <p-button
              label="Cancelar"
              size="small"
              icon="pi pi-times"
              severity="secondary"
              [disabled]="m.status === 'cancelled'"
              (click)="cancel(m.id)"
            />
            <p-button
              label="Reabrir"
              size="small"
              icon="pi pi-refresh"
              severity="contrast"
              [disabled]="m.status === 'pending'"
              (click)="reopen(m.id)"
            />
          </div>
        </td>
      </tr>
    </ng-template>
  </p-table>
</div>
